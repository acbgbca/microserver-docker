---
- hosts: localhost
  
  vars:
    all: {}

  tasks:
  - name: Load Docker Stacks
    include_vars:
      file: "{{ item }}"
      name: all
      hash_behaviour: merge
    when: filename is not defined
    loop: "{{ query('fileglob', 'stacks/*.yml') }}"
    tags: always
  - name: Load Single Docker Stack
    block:
      - name: Check file exists
        ansible.builtin.stat:
          path: "stacks/{{ filename }}.yml"
        register: file_data
      - name: Fail if file missing
        ansible.builtin.fail:
          msg: "File stacks/{{ filename }}.yml does not exist"
        when: not file_data.stat.exists
      - name: "Load {{ filename }}"
        include_vars:
          file: "stacks/{{ filename }}.yml"
          name: all
        when: file_data.stat.exists
    when: filename is defined
    tags: always
  - name: Create Stacks
    include_tasks: includes/stack.yml
    loop: "{{ all | dict2items }}"
    loop_control:
      loop_var: file
    tags: always