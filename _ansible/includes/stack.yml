---
- name: Setup compose directory for {{ file.key }}
  file:
    path: "../{{ file.key }}"
    state: directory
- name: Create compose files for {{ file.key }}
  ansible.builtin.template:
    src: templates/docker_compose.yml.j2
    dest: "../{{ file.key }}/docker_compose.yaml"
  vars:
    stack: "{{ file.value }}"
    stackName: "{{ file.key }}"
- name: Create root env file for {{ file.key }}
  ansible.builtin.template:
    src: templates/env.j2
    dest: "../{{ file.key }}/2.env"
  when: file.value.rootEnv is defined
  vars:
    envFile: "{{ file.value.rootEnv }}"
- name: Create env file for {{ file.key }}
  ansible.builtin.template:
    src: templates/env.j2
    dest: "../{{ file.key }}/{{ file.key }}2.env"
  when: file.value.envFile is defined
  vars:
    envFile: "{{ file.value.envFile }}"
- name: Create env file from template for {{ file.key }}
  ansible.builtin.template:
    src: "./stacks/{{ file.key }}/{{ file.value.envFileTemplate.template }}"
    dest: "../{{ file.key }}/{{ file.key }}2.env"
  when: file.value.envFileTemplate is defined
  vars:
    envVars: "{{ file.value.envFileTemplate }}"
# - name: Debug directories for {{ file.key }}
#   ansible.builtin.debug:
#     msg: "../{{ file.key }}/{{ item.1.local }}"
#   when: item.1.local is defined
#   loop: "{{ file.value.services|subelements('volumes') }}"
- name: Setup local directories for {{ file.key }}
  file:
    path: "../{{ file.key }}/{{ item.1.local }}"
    state: directory
  when: item.1.local is defined
  loop: "{{ file.value.services|subelements('volumes', skip_missing=True) }}"
- name: Add gitignore to local directory for {{ file.key }}
  ansible.builtin.template:
    src: templates/gitignore.j2
    dest: "../{{ file.key }}/{{ item.1.local }}/.gitignore"
  when: item.1.local is defined
  loop: "{{ file.value.services|subelements('volumes', skip_missing=True) }}"
- name: Setup data directories for {{ file.key }}
  file:
    path: "{{ baseDataDir }}/{{ file.key }}/{{ item.1.data }}"
    state: directory
  when: item.1.data is defined
  loop: "{{ file.value.services|subelements('volumes', skip_missing=True) }}"
- name: Setup traefik config for {{ file.key }}
  ansible.builtin.template:
    src: templates/traefik.yaml.j2
    dest: "{{ traefikConfigDir }}/{{ file.key }}.yaml"
  vars:
    stack: "{{ file.value }}"
  when: file.value.services|selectattr('exposed', 'defined')|length > 0
  tags:
    - traefik

